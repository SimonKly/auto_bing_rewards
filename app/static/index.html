<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bing Rewards 自动化仪表板</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        .progress-container {
            display: flex;
            align-items: center;
        }
        progress {
            width: 100px;
            height: 20px;
            margin-right: 10px;
        }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        .running {
            background-color: #ffeb3b;
        }
        .idle {
            background-color: #4caf50;
            color: white;
        }
        button {
            padding: 8px 16px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #1976D2;
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
        }
        .refresh-btn {
            background-color: #4CAF50;
        }
        .run-all-btn {
            background-color: #FF9800;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Bing Rewards 自动化仪表板</h1>
        
        <div class="controls">
            <button class="refresh-btn" onclick="renderTable()">刷新状态</button>
            <button class="run-all-btn" onclick="runAllTasks()">运行全部</button>
        </div>
        
        <table id="accountTable">
            <thead>
                <tr>
                    <th>账号 (Account)</th>
                    <th>邮箱 (Email)</th>
                    <th>PC 搜索进度</th>
                    <th>移动端进度</th>
                    <th>最后运行时间</th>
                    <th>状态</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // 渲染表格
        async function renderTable() {
            try {
                const data = await fetchAccounts();
                let html = '';
                
                data.forEach(acc => {
                    const pcValue = parseProgressValue(acc.pc_search_progress);
                    const pcMax = 90;
                    const mobileValue = parseProgressValue(acc.mobile_search_progress);
                    const mobileMax = 60;
                    
                    html += `
                    <tr>
                        <td>${acc.username}</td>
                        <td>${acc.email}</td>
                        <td>
                            <div class="progress-container">
                                <progress value="${pcValue}" max="${pcMax}"></progress>
                                <span>${acc.pc_search_progress}</span>
                            </div>
                        </td>
                        <td>
                            <div class="progress-container">
                                <progress value="${mobileValue}" max="${mobileMax}"></progress>
                                <span>${acc.mobile_search_progress}</span>
                            </div>
                        </td>
                        <td>${formatDateTime(acc.last_run)}</td>
                        <td>
                            <span class="badge ${acc.status === 'Running' ? 'running' : 'idle'}">
                                ${acc.status}
                            </span>
                        </td>
                        <td>
                            <button onclick="startTask(${acc.id})">立即执行</button>
                        </td>
                    </tr>`;
                });
                
                $('#accountTable tbody').html(html);
            } catch (error) {
                console.error('渲染表格时出错:', error);
            }
        }

        // 获取账户数据
        async function fetchAccounts() {
            const response = await fetch('/api/accounts');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return await response.json();
        }

        // 开始单个账户任务
        async function startTask(accountId) {
            try {
                const response = await fetch(`/api/run/${accountId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('任务已启动');
                    // 刷新表格以显示最新状态
                    setTimeout(renderTable, 2000);
                } else {
                    const errorData = await response.json();
                    alert(`启动任务失败: ${errorData.detail || '未知错误'}`);
                }
            } catch (error) {
                console.error('启动任务时出错:', error);
                alert(`启动任务失败: ${error.message}`);
            }
        }

        // 运行所有任务
        async function runAllTasks() {
            try {
                const accounts = await fetchAccounts();
                
                for (const account of accounts) {
                    console.log(`启动账户 ${account.username} 的任务`);
                    try {
                        await fetch(`/api/run/${account.id}`, { method: 'POST' });
                        // 避免同时启动太多任务，延时一下
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    } catch (err) {
                        console.error(`启动账户 ${account.username} 任务失败:`, err);
                    }
                }
                
                alert('已启动所有账户的任务');
                setTimeout(renderTable, 2000);
            } catch (error) {
                console.error('运行所有任务时出错:', error);
                alert(`运行所有任务失败: ${error.message}`);
            }
        }

        // 解析进度值
        function parseProgressValue(progressStr) {
            if (!progressStr || typeof progressStr !== 'string') return 0;
            const match = progressStr.match(/(\d+)\/\d+/);
            return match ? parseInt(match[1], 10) : 0;
        }

        // 格式化日期时间
        function formatDateTime(dateString) {
            if (!dateString) return '从未';
            
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }

        // 页面加载完成后自动渲染表格
        $(document).ready(function() {
            renderTable();
            
            // 每30秒自动刷新一次
            setInterval(renderTable, 30000);
        });
    </script>
</body>
</html>